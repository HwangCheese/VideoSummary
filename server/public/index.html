<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¥ ìˆí¼ ìš”ì•½</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 { margin-bottom: 1rem; }
    #dropZone {
      width: 600px;
      height: 180px;
      border: 3px dashed #6c757d;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      color: #6c757d;
      transition: background-color 0.3s, border-color 0.3s;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    #dropZone.hover {
      background-color: #e2e6ea;
      border-color: #495057;
      color: #495057;
    }
    
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }
    button:disabled {
      background-color: #adb5bd;
      cursor: not-allowed;
    }
    button:not(:disabled):hover {
      background-color: #0056b3;
    }
    #status {
      margin-top: 1rem;
      font-weight: 500;
    }

    /* ê¸°ì¡´ .spinner (ì›í˜• ë¡œë”©) ì œê±° ë˜ëŠ” ì‚¬ìš© ì•ˆ í•¨ */

    /* [ìˆ˜í‰ ì§„í–‰ë°”] */
    #progressBarContainer {
      width: 400px;
      height: 20px;
      background: #eee;
      border-radius: 10px;
      margin-top: 1rem;
      overflow: hidden;
      /* ê°€ìš´ë° ì •ë ¬ ìœ„í•´ margin: 0 auto; ë“± ì¶”ê°€ ê°€ëŠ¥ */
    }
    #progressBarInner {
      width: 0%;
      height: 100%;
      background: #007bff;
      border-radius: 10px;
      transition: width 0.3s;
    }

  </style>
</head>
<body>

<h1>ğŸ¬ ë¹„ë””ì˜¤ -> ìˆí¼ ìš”ì•½ ì„œë¹„ìŠ¤</h1>

<div id="dropZone">ğŸ“‚ .mp4 íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”</div>
<button id="startBtn" disabled>ìˆí¼ ìƒì„±</button>

<!-- ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
<p id="status"></p>
<div id="progressBarContainer">
  <div id="progressBarInner"></div>
</div>

<h2>âœ¨ ìˆí¼ ê²°ê³¼ ì˜ìƒ</h2>
<video id="finalVideo" controls style="width:700px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2); display:none;"></video>

<h2>ğŸ” ì›ë³¸ ëŒ€ë¹„ í•˜ì´ë¼ì´íŠ¸ êµ¬ê°„</h2>
<div id="highlightBarContainer"
     style="width:700px; height:30px; background:#aaffaa; border-radius:8px; position:relative; overflow:visible; display:none;">
</div>


<script>
let uploadedFileName = "";
const dropZone = document.getElementById("dropZone");
const startBtn = document.getElementById("startBtn");
const statusDiv = document.getElementById("status");
const finalVideo = document.getElementById("finalVideo");

// [ìˆ˜í‰ ì§„í–‰ë°” DOM]
const progressBarInner = document.getElementById("progressBarInner");

// 1) ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
["dragenter", "dragover"].forEach(eventName => {
  dropZone.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add("hover");
  }, false);
});
["dragleave", "drop"].forEach(eventName => {
  dropZone.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove("hover");
  }, false);
});

// 2) íŒŒì¼ ë“œë¡­
dropZone.addEventListener("drop", async e => {
  e.preventDefault();
  e.stopPropagation();

  const dt = e.dataTransfer;
  const files = dt?.files;

  if (!files || !files.length) {
    alert("âš ï¸ íŒŒì¼ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const file = files[0];
  if (!file.name.endsWith(".mp4")) {
    alert("âš ï¸ mp4 íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  statusDiv.textContent = "â³ ì—…ë¡œë“œ ì¤‘...";
  progressBarInner.style.width = "10%"; // ì„ì˜ë¡œ ì—…ë¡œë“œ ì‹œì‘ ì‹œ 10%

  const formData = new FormData();
  formData.append("video", file);

  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();

    if (res.ok) {
      uploadedFileName = data.filename;
      statusDiv.textContent = `âœ… ì—…ë¡œë“œ ì„±ê³µ: ${uploadedFileName}`;
      progressBarInner.style.width = "20%";
      startBtn.disabled = false;
    } else {
      statusDiv.textContent = "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨";
      progressBarInner.style.width = "0%";
    }
  } catch (error) {
    console.error(error);
    statusDiv.textContent = "âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
    progressBarInner.style.width = "0%";
  }
});

// 3) **ìˆí¼ ìƒì„± ë²„íŠ¼** ëˆ„ë¥´ë©´ /upload/process?filename=... í˜¸ì¶œ
startBtn.addEventListener("click", async () => {
  if (!uploadedFileName) return;

  statusDiv.textContent = "ğŸ§  ìƒì„± ì‹œì‘ ëŒ€ê¸° ì¤‘...";
  progressBarInner.style.width = "30%";
  startBtn.disabled = true;

  try {
    const res = await fetch(`/upload/process?filename=${uploadedFileName}`);
    const data = await res.json();

    if (res.ok) {
      statusDiv.textContent = "ğŸ‰ ìˆí¼ ì˜ìƒ ìƒì„± ì™„ë£Œ!";
      progressBarInner.style.width = "100%";
      finalVideo.src = `/clips/highlight_${uploadedFileName}?` + Date.now();
      finalVideo.style.display = "block";
      // í•˜ì´ë¼ì´íŠ¸ ì˜ìƒ ë¡œë”©ëœ ë‹¤ìŒì— highlightBar ê°±ì‹ 
      finalVideo.addEventListener("loadedmetadata", showHighlightBar, { once: true });
    } else {
      statusDiv.textContent = "âŒ ìˆí¼ ìƒì„± ì‹¤íŒ¨";
      progressBarInner.style.width = "0%";
      startBtn.disabled = false;
    }
  } catch (error) {
    console.error(error);
    statusDiv.textContent = "âŒ ìˆí¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
    progressBarInner.style.width = "0%";
    startBtn.disabled = false;
  }
});

// 4) í•˜ì´ë¼ì´íŠ¸ ë°” í‘œì‹œ
async function showHighlightBar() {
  const baseName = uploadedFileName.split('.').slice(0, -1).join('.');
  const jsonName = `highlight_${baseName}.json`;
  const res = await fetch(`/clips/${jsonName}`);
  const data = await res.json();
  const segments = data.segments || [];
  const originalDuration = data.original_duration || 60;
  if (!segments.length || !originalDuration) return;

  const bar = document.getElementById("highlightBarContainer");
  bar.innerHTML = "";
  bar.style.display = "block";

  segments.forEach(seg => {
    const start = seg.start_time;
    const end = seg.end_time;
    const segLen = end - start;
    const percentStart = (start / originalDuration) * 100;
    const percentWidth = (segLen / originalDuration) * 100;

    const block = document.createElement("div");
    block.style.position = "absolute";
    block.style.left = `${percentStart}%`;
    block.style.width = `${percentWidth}%`;
    block.style.height = "100%";
    block.style.backgroundColor = "red";
    block.style.borderRadius = "8px";
    block.style.boxShadow = "0 0 4px rgba(0,0,0,0.3)";

    const tooltip = document.createElement("div");
    tooltip.textContent = `${formatTime(start)} ~ ${formatTime(end)}`;
    tooltip.style.position = "absolute";
    tooltip.style.bottom = "100%";
    tooltip.style.left = "50%";
    tooltip.style.transform = "translateX(-50%)";
    tooltip.style.backgroundColor = "black";
    tooltip.style.color = "white";
    tooltip.style.padding = "4px 8px";
    tooltip.style.borderRadius = "6px";
    tooltip.style.fontSize = "0.8rem";
    tooltip.style.whiteSpace = "nowrap";
    tooltip.style.display = "none";
    tooltip.style.zIndex = "10";

    block.appendChild(tooltip);
    block.addEventListener("mouseenter", () => tooltip.style.display = "block");
    block.addEventListener("mouseleave", () => tooltip.style.display = "none");

    bar.appendChild(block);
  });
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = Math.floor(seconds % 60);
  return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
}

// SSE ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", () => {
  // SSE ì—°ê²°
  const evtSource = new EventSource("/upload/progress-sse");
  evtSource.onmessage = function(e) {
    const progressState = JSON.parse(e.data);
    console.log("SSE onmessage:", progressState);

    // step(1,2,3)ì— ë”°ë¼ ëŒ€ëµ %ë¡œ ê³„ì‚°
    let percent = 0;
    if (progressState.step === 1) percent = 30;
    else if (progressState.step === 2) percent = 60;
    else if (progressState.step === 3) percent = 90;

    if (progressState.done) {
      percent = 100;
    }

    progressBarInner.style.width = percent + "%";
    if (progressState.message) {
      // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      document.getElementById("status").textContent = `${percent}% - ${progressState.message}`;
    }

    if (progressState.done) {
      evtSource.close();
    }
  };
});
</script>

</body>
</html>